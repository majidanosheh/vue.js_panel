# üìÑ PROJECT: AnosheCMS - Master Context
# üë§ Lead Developer: Majid
# ü§ñ AI Role: Senior Full-Stack Architect & Code Reviewer
# üéØ Core Goal: Enterprise-grade Headless CMS (High maintainability, Scalability, Performance)
# üìÖ Last Update: 2025-12-05 (Phase 3 Completed, Phase 4 Audit Started)

## 1. üèóÔ∏è Architecture & Patterns (The Rules)
- **Style:** Clean Architecture (Onion Architecture).
  - **Domain:** Pure entities, Enums, Constants (No external dependencies).
  - **Application:** Interfaces, DTOs, Services (Depends on Domain).
  - **Infrastructure:** DbContext, Migrations, FileSystem, Email (Depends on Application).
  - **API:** Controllers, Middleware, Entry Point (Depends on Application & Infra).

- **Design Patterns:**
  - **Result Pattern:** Use wrapper objects (Success/Fail) instead of Exceptions for logic flow.
  - **Dependency Injection (DI):** Strict usage for all services.
  - **Repository/UoW:** (Target Goal) Currently using Service->DbContext pattern, moving towards abstraction where necessary.

## 2. üõ†Ô∏è Technology Stack
- **Backend:** ASP.NET Core 8 (Web API)
  - **ORM:** Entity Framework Core (SQL Server)
  - **Validation:** FluentValidation (Server-side)
  - **Mapping:** Manual Mapping / AutoMapper (Registered)
- **Frontend:** Vue.js 3 (Composition API, <script setup>)
  - **State:** Pinia (Setup Stores)
  - **Build:** Vite
  - **HTTP:** Axios (w/ Robust Interceptors)
  - **UI/Style:** Custom CSS + Bootstrap (Planned), VueDraggable (for FormBuilder)

## 3. üóÑÔ∏è Database & EF Core Strategy
- **Approach:** Code-First with Migrations.
- **Configuration:** Fluent API (in `IEntityTypeConfiguration` classes). **No Data Attributes** in Domain.
- **Performance:** - `AsNoTracking()` for read-only queries.
  - `SplitQuery` for complex joins.
- **Features:**
  - **Soft Delete:** Implemented via `ISoftDelete` & Global Query Filters.
  - **Auditing:** Automatic `Create/Update` tracking in `SaveChanges` override.
  - **JSON Handling:** `ReferenceHandler.IgnoreCycles` enabled in Startup.

## 4. ‚úÖ Current Implementation Status (What is DONE)

### A. Authentication & Security üõ°Ô∏è
- **Auth:** JWT (Access + Refresh Token).
- **Backdoor:** `Rescue Admin` endpoint available at `/api/auth/rescue`.
- **RBAC:** Dynamic Permissions (not just Roles).
- **Frontend:** `authStore.js` handles casing (Pascal/Camel) & decodes JWT permissions. `v-can` directive implemented.

### B. User Management üë•
- Full CRUD (Create, Edit, Soft Delete, List).
- Role Management with Permission Matrix (Checkbox UI).

### C. Form Builder Module (The Core Feature) üìù
- **Backend:**
  - `Form` & `FormField` entities (with `Options` property for Select/Radio).
  - `PublicFormController`: Anonymous access for rendering.
  - **Fixes:** Solved JSON 500 error & EF Core translation issues (`MapToDTO` in memory).
- **Frontend:**
  - **Designer:** Drag & Drop interface (`VueDraggable`).
  - **Properties Panel:** Edit Label, Required, Options (newline separated).
  - **Renderer:** Public view engine (`/view/:slug`) fully functional.
  - **Store:** Smart updates (no page refresh data loss).

## 5. üöß Pending Tasks (Roadmap)
1.  **Audit Log Viewer (Phase 4 - Current Focus):**
    - **Status:** DB table `AuditLogs` is filling up automatically.
    - **Missing:** Admin UI to view logs (Grid), Filtering, JSON Diff Viewer.
    - **Action:** Create `AuditLogService`, `AuditLogDto`, `AdminAuditController`.
2.  **Content Management (Phase 5):**
    - Define dynamic Content Types (Articles, Products).
    - Content Entry Editor.

## 6. ü§ñ AI Persona Instructions (My Job)
1.  **Code Review First:** Check for Clean Arch violations (e.g., Domain depending on Infra) before generating code.
2.  **Safety:** Assume all inputs are dangerous (XSS/SQLi prevention).
3.  **Refactoring:** Suggest cleaner/shorter logic (e.g., extracting methods).
4.  **Communication Style:**
    - **Direct & Technical:** No fluff.
    - **Visual-First:** Use emojis, bullet points, and clear structure.
    - **Step-by-Step:** Break down complex tasks (ADHD-friendly).
    - **Continuity:** Always remember the project state from this file.